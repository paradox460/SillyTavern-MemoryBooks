# 📕 Memory Books (SillyTavern 확장 기능)

SillyTavern을 위한 차세대 자동, 구조화된 신뢰성 높은 메모리 생성 확장 기능입니다. 채팅에서 장면(Scene)을 표시하고, AI로 JSON 기반 요약을 생성하여 로어북에 "[vectorized](#vectorized)" 항목으로 저장합니다. 그룹 채팅, 고급 프로필 관리, 강력한 API/모델 처리를 지원합니다.

여기서 시작하세요:

- ⚠️‼️설치 시 주의 사항은 [사전 요구 사항](#-prerequisites)을 읽어주세요 (특히 Text Completion API를 사용하는 경우)
- ❓ [자주 묻는 질문 (FAQ)](#FAQ)
- 🛠️ [문제 해결 (Troubleshooting)](#Troubleshooting)

기타 링크:

- 📘 [사용자 가이드 (영문)](USER_GUIDE.md)
- 📋 [버전 기록 및 변경 로그](changelog.md)
- 💡 [📚 Lorebook Ordering과 함께 📕 Memory Books 사용하기](https://github.com/aikohanasaki/SillyTavern-LorebookOrdering/blob/main/guides/STMB%20and%20STLO%20-%20English.md)

---

### 📚 Lorebook Ordering (STLO)으로 더 강력하게

고급 메모리 정리와 더 깊은 스토리 통합을 위해, STMB를 [SillyTavern-LorebookOrdering (STLO)](https://github.com/aikohanasaki/SillyTavern-LorebookOrdering/blob/main/guides/STMB%20and%20STLO%20-%20English.md)와 함께 사용하는 것을 강력히 권장합니다. 모범 사례, 설정 방법, 팁은 가이드를 참조하세요!

> 참고: 다양한 언어를 지원합니다: [`/locales`](locales) 폴더에서 목록을 확인하세요. 다국어/현지화된 Readme 및 사용자 가이드는 [`/userguides`](userguides) 폴더에서 찾을 수 있습니다.
> 로어북 변환기 및 사이드 프롬프트 템플릿 라이브러리는 [`/resources`](resources) 폴더에 있습니다.

---

## 📋 사전 요구 사항

- **SillyTavern:** 1.13.5 이상 (최신 버전 권장)
- ⚠️‼️**모든 사용자를 위해 설치 (INSTALL FOR ALL USERS):**‼️⚠️ STMB는 ST 기본 코드를 많이 재사용하므로, 함수 가져오기 오류를 방지하기 위해 확장 기능이 `/public/scripts/extensions/third-party/SillyTavern-MemoryBooks` 경로에 위치하도록 반드시 모든 사용자를 위해 설치해야 합니다.
- **장면 선택 (Scene Selection):** 시작 및 종료 마커(시작 < 종료)가 설정되어야 합니다.
- **Chat Completion 지원:** OpenAI, Claude, Anthropic, OpenRouter 또는 기타 Chat Completion API를 완벽하게 지원합니다.
- **Text Completion 지원:** Text Completion API (Kobold, TextGen 등)는 Chat Completion (OpenAI 호환) API 엔드포인트를 통해 연결될 때 지원됩니다. 아래의 KoboldCpp 팁에 따라 Chat Completion API 연결을 설정하는 것을 권장합니다 (Ollama나 다른 소프트웨어를 사용하는 경우 필요에 따라 변경하세요). 그 후, STMB 프로필을 설정하고 사용자 지정(권장) 또는 전체 수동 구성(사용자 지정이 실패하거나 사용자 지정 연결이 두 개 이상인 경우에만)을 사용하세요.

### 📕 ST Memory Books 사용을 위한 KoboldCpp 팁

ST에서 다음과 같이 설정하세요 (STMB가 작동한 후에는 다시 Text Completion으로 변경할 수 있습니다):

- Chat Completion API 선택
- Custom chat completion source 선택
- `http://localhost:5001/v1` 엔드포인트 입력 (`127.0.0.1:5000/v1`도 사용 가능)
- "custom API key"에 아무거나 입력 (상관없으나 ST에서 입력을 요구함)
- 모델 ID는 반드시 `koboldcpp/modelname` 형식이어야 함 (모델 이름에 .gguf를 넣지 마세요!)
- chat completion preset을 다운로드하여 가져오기 (어떤 것이든 상관없음), 단순히 chat completion preset을 **가지고** 있기 위함입니다. "지원되지 않음" 오류를 방지합니다.

## 💡 권장 글로벌 월드 인포/로어북 활성화 설정

- **Match Whole Words:** 체크 해제 (false)
- **Scan Depth:** 높을수록 좋음 (작성자는 8로 설정)
- **Max Recursion Steps:** 2 (일반적인 권장 사항, 필수는 아님)
- **Context %:** 80% (100,000 토큰 컨텍스트 윈도우 기준) - 채팅 기록이나 봇이 매우 무겁지 않다고 가정할 때.

---

## 🚀 시작하기

### 1. **설치 및 로드**

- SillyTavern을 로드하고 캐릭터 또는 그룹 채팅을 선택합니다.
- 채팅 메시지에 쉐브론 버튼(► ◄)이 나타날 때까지 기다립니다 (최대 10초 소요).

![이 버튼들이 나타날 때까지 기다리세요](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/startup.png)

### 2. **장면(Scene) 표시**

- 장면의 첫 번째 메시지에서 ►를 클릭합니다.
- 마지막 메시지에서 ◄를 클릭합니다.

![장면 선택을 보여주는 시각적 피드백](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/button-start.png)

### 3. **메모리 생성**

- 확장 기능 메뉴(마술봉 🪄)를 열고 "Memory Books"를 클릭하거나, `/creatememory` 슬래시 커맨드를 사용합니다.
- 메시지가 표시되면 설정(프로필, 컨텍스트, API/모델)을 확인합니다.
- AI 생성 및 자동 로어북 항목 저장을 기다립니다.

---

## 🆕 슬래시 커맨드 단축키

- `/creatememory`: 기존의 쉐브론 시작/종료 마커를 사용하여 메모리를 생성합니다.
- `/scenememory x-y`: 메시지 x에서 시작하여 메시지 y로 끝나는 메모리를 생성합니다.
- `/nextmemory`: 마지막 메모리 이후의 모든 메시지로 메모리를 생성합니다.

## 👥 그룹 채팅 지원

- 모든 기능이 그룹 채팅에서 작동합니다.
- 장면 마커, 메모리 생성 및 로어북 통합은 그룹 메타데이터에 저장됩니다.
- 특별한 설정이 필요 없으며, 그룹 채팅을 선택하고 평소처럼 사용하면 됩니다.

---

## 🧭 작동 모드

### **자동 모드 (기본값)**

- **작동 방식:** 현재 채팅에 바인딩된 로어북을 자동으로 사용합니다.
- **추천 대상:** 단순함과 속도를 원하는 경우. 대부분의 사용자는 여기서 시작해야 합니다.
- **사용법:** 캐릭터나 그룹 채팅의 "채팅 로어북(Chat Lorebooks)" 드롭다운에서 로어북이 선택되어 있는지 확인하세요.

![채팅 로어북 바인딩 예시](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/chatlorebook.png)

### **로어북 자동 생성 모드** ⭐ _v4.2.0 신규 기능_

- **작동 방식:** 로어북이 없는 경우 사용자 지정 명명 템플릿을 사용하여 새 로어북을 자동으로 생성하고 바인딩합니다.
- **추천 대상:** 신규 사용자 및 빠른 설정. 원클릭 로어북 생성에 완벽합니다.
- **사용법:**
  1. 확장 기능 설정에서 "Auto-create lorebook if none exists"를 활성화합니다.
  2. 명명 템플릿을 구성합니다 (기본값: "LTM - {{char}} - {{chat}}").
  3. 바인딩된 로어북 없이 메모리를 생성하면, 자동으로 생성되어 바인딩됩니다.
- **템플릿 플레이스홀더:** {{char}} (캐릭터 이름), {{user}} (사용자 이름), {{chat}} (채팅 ID)
- **스마트 넘버링:** 중복된 이름이 존재하는 경우 자동으로 번호(2, 3, 4...)를 추가합니다.
- **참고:** 수동 로어북 모드와 동시에 사용할 수 없습니다.

### **수동 로어북 모드**

- **작동 방식:** 메인 채팅에 바인딩된 로어북을 무시하고, 채팅별로 메모리를 저장할 다른 로어북을 선택할 수 있게 합니다.
- **추천 대상:** 메모리를 특정 별도 로어북으로 지정하고 싶은 고급 사용자.
- **사용법:**
  1. 확장 기능 설정에서 "Enable Manual Lorebook Mode"를 활성화합니다.
  2. 채팅에서 처음 메모리를 생성할 때 로어북을 선택하라는 메시지가 표시됩니다.
  3. 이 선택은 해당 채팅에 대해 저장되며, 지우거나 자동 모드로 전환할 때까지 유지됩니다.
- **참고:** 로어북 자동 생성 모드와 동시에 사용할 수 없습니다.

---

## 📝 메모리 생성

### **JSON 전용 출력**

모든 프롬프트와 프리셋은 **반드시** 유효한 JSON만 반환하도록 AI에 지시해야 합니다. 예:

```json
{
  "title": "짧은 장면 제목",
  "content": "장면에 대한 상세 요약...",
  "keywords": ["키워드1", "키워드2"]
}
```

**응답에는 이 외의 다른 텍스트가 포함되어서는 안 됩니다.**

### **내장 프리셋**

1. **Summary:** 상세한 비트 단위 요약.
2. **Summarize:** 타임라인, 비트, 상호작용, 결과에 대한 마크다운 헤더 포함.
3. **Synopsis:** 포괄적이고 구조화된 마크다운.
4. **Sum Up:** 타임라인이 포함된 간결한 비트 요약.
5. **Minimal:** 1-2 문장 요약.

### **사용자 지정 프롬프트**

- 직접 만들 수 있지만, **반드시** 위와 같이 유효한 JSON을 반환해야 합니다.

---

## 📚 로어북 통합

- **자동 항목 생성:** 새로운 메모리는 모든 메타데이터와 함께 항목으로 저장됩니다.
- **플래그 기반 감지:** `stmemorybooks` 플래그가 있는 항목만 메모리로 인식됩니다.
- **자동 넘버링:** 순차적인 0이 채워진 번호 매기기 (`[000]`, `(000)`, `{000}`, `#000` 등 다양한 형식 지원).
- **수동/자동 순서:** 프로필별 삽입 순서 설정.
- **에디터 새로고침:** 메모리 추가 후 로어북 에디터를 자동으로 새로고침하는 옵션 제공.

> **기존 메모리는 변환해야 합니다!**
> [Lorebook Converter](https://www.google.com/search?q=/resources/lorebookconverter.html)를 사용하여 `stmemorybooks` 플래그와 필수 필드를 추가하세요.

---

### 🎡 사이드 프롬프트 (Side Prompts)

사이드 프롬프트는 추적기(tracker)처럼 사용할 수 있으며 메모리 로어북에 항목을 생성합니다.

- **접근:** Memory Books 설정에서 “🎡 Side Prompt Manager”를 클릭하세요.
- **기능:**
- 모든 사이드 프롬프트 보기.
- 새로운 프롬프트를 생성하거나 복제하여 다양한 프롬프트 스타일 실험.
- 모든 프리셋(내장 프리셋 포함) 편집 또는 삭제.
- 백업이나 공유를 위해 프리셋을 JSON 파일로 내보내기 및 가져오기.
- 수동으로 실행하거나 메모리 생성 시 자동으로 실행.

- **사용 팁:**
- 새 프롬프트를 만들 때 호환성을 위해 내장된 것을 복사하여 사용할 수 있습니다.
- 추가 사이드 프롬프트 템플릿 라이브러리 [JSON 파일](https://www.google.com/search?q=resources/SidePromptTemplateLibrary.json) - 가져오기만 하면 바로 사용 가능

---

### 🧠 고급 커스터마이징을 위한 정규식(Regex) 통합

- **텍스트 처리에 대한 완전한 제어**: Memory Books는 이제 SillyTavern의 **Regex** 확장 기능과 통합되어 두 가지 주요 단계에서 강력한 텍스트 변환을 적용할 수 있습니다:

1. **프롬프트 생성 (Prompt Generation)**: **User Input** 배치를 대상으로 하는 정규식 스크립트를 생성하여 AI로 전송되는 프롬프트를 자동으로 수정합니다.
2. **응답 파싱 (Response Parsing)**: **AI Output** 배치를 대상으로 하여 저장되기 전에 AI의 원시 응답을 정리, 재포맷 또는 표준화합니다.

- **다중 선택 지원**: 이제 정규식 스크립트를 다중 선택할 수 있습니다. 활성화된 모든 스크립트는 각 단계(프롬프트 생성 및 응답 파싱)에서 순차적으로 적용되어 고급스럽고 유연한 변환이 가능합니다.
- **작동 방식**: 통합은 원활하게 이루어집니다. Regex 확장 기능에서 원하는 스크립트를 생성하고 활성화(다중 선택)하기만 하면, Memory Books가 메모리 및 사이드 프롬프트 생성 중에 자동으로 적용합니다.

---

## 👤 프로필 관리

- **프로필:** 각 프로필에는 API, 모델, 온도(temperature), 프롬프트/프리셋, 제목 형식 및 로어북 설정이 포함됩니다.
- **가져오기/내보내기:** 프로필을 JSON으로 공유합니다.
- **프로필 생성:** 고급 옵션 팝업을 사용하여 새 프로필을 저장합니다.
- **프로필별 오버라이드:** 메모리 생성 시 API/모델/온도를 일시적으로 전환한 다음 원래 설정을 복원할 수 있습니다.

---

## ⚙️ 설정 및 구성

### **글로벌 설정**

[Youtube의 짧은 영상 개요](https://youtu.be/mG2eRH_EhHs)

- **Manual Lorebook Mode:** 채팅별로 로어북을 선택하려면 활성화하세요.
- **Auto-create lorebook if none exists:** ⭐ _v4.2.0 신규 기능_ - 명명 템플릿을 사용하여 로어북을 자동으로 생성하고 바인딩합니다.
- **Lorebook Name Template:** ⭐ _v4.2.0 신규 기능_ - {{char}}, {{user}}, {{chat}} 플레이스홀더를 사용하여 자동 생성되는 로어북 이름을 사용자 지정합니다.
- **Allow Scene Overlap:** 겹치는 메모리 범위를 허용하거나 방지합니다.
- **Always Use Default Profile:** 확인 팝업을 건너뜁니다.
- **Show memory previews:** 로어북에 추가하기 전에 메모리를 검토하고 편집할 수 있는 미리보기 팝업을 활성화합니다.
- **Show Notifications:** 토스트 메시지 표시를 토글합니다.
- **Refresh Editor:** 메모리 생성 후 로어북 에디터를 자동으로 새로고침합니다.
- **Token Warning Threshold:** 큰 장면에 대한 경고 레벨을 설정합니다 (기본값: 30,000).
- **Default Previous Memories:** 컨텍스트로 포함할 이전 메모리의 수 (0-7).
- **Auto-create memory summaries:** 일정 간격으로 자동 메모리 생성을 활성화합니다.
- **Auto-Summary Interval:** 메모리 요약을 자동으로 생성할 메시지 수 간격 (10-200, 기본값: 100).
- **Memory Title Format:** 선택하거나 사용자 지정합니다 (아래 참조).

### **프로필 필드**

- **Name:** 표시 이름.
- **API/Provider:** openai, claude, custom 등.
- **Model:** 모델 이름 (예: gpt-4, claude-3-opus).
- **Temperature:** 0.0–2.0.
- **Prompt or Preset:** 사용자 지정 또는 내장.
- **Title Format:** 프로필별 템플릿.
- **Activation Mode:** Vectorized, Constant, Normal.
- **Position:** ↑Char, ↓Cha, ↑EM, ↓EM, ↑AN, Outlet (및 필드 이름).
- **Order Mode:** 자동/수동.
- **Recursion:** 재귀(recursion) 방지/지연.

---

## 🏷️ 제목 서식 지정

강력한 템플릿 시스템을 사용하여 로어북 항목의 제목을 사용자 지정하세요.

- **플레이스홀더:**
- `{{title}}` - AI가 생성한 제목 (예: "운명적인 만남").
- `{{scene}}` - 메시지 범위 (예: "Scene 15-23").
- `{{char}}` - 캐릭터 이름.
- `{{user}}` - 사용자 이름.
- `{{messages}}` - 장면 내 메시지 수.
- `{{profile}}` - 생성에 사용된 프로필 이름.
- 다양한 형식의 현재 날짜/시간 플레이스홀더 (예: 날짜는 `August 13, 2025`, 시간은 `11:08 PM`).

- **자동 넘버링:** `[0]`, `[00]`, `(0)`, `{0}`, `#0` 사용, 그리고 `#[000]`, `([000])`, `{[000]}`와 같이 래핑된 형식을 사용하여 순차적이고 0이 채워진 번호 매기기를 지원합니다.
- **사용자 지정 형식:** 고유한 형식을 만들 수 있습니다. v4.5.1부터는 모든 출력 가능한 유니코드 문자(이모지, 한중일 문자, 악센트, 기호 등 포함)가 제목에 허용됩니다. 유니코드 제어 문자만 차단됩니다.

---

## 🧵 컨텍스트 메모리

- 더 나은 연속성을 위해 **최대 7개의 이전 메모리 포함**.
- **토큰 추정**에 정확성을 위해 컨텍스트 메모리가 포함됩니다.

---

## 🎨 시각적 피드백 및 접근성

- **버튼 상태:**
- 비활성, 활성, 유효한 선택, 장면 내 포함, 처리 중.

- **접근성:**
- 키보드 탐색, 포커스 표시기, ARIA 속성, 동작 줄이기, 모바일 친화적.

---

# 자주 묻는 질문 (FAQ)

### 확장 기능 메뉴에서 Memory Books를 찾을 수 없습니다!

설정은 확장 기능 메뉴(입력 상자 왼쪽의 마술봉 🪄)에 있습니다. "Memory Books"를 찾으세요.

### 벡터(vectors)를 실행해야 하나요?

월드 인포의 🔗 항목은 ST의 UI에서 "vectorized"라고 명명되어 있습니다. 그래서 제가 vectorized라는 단어를 사용하는 것입니다. 벡터 확장 기능을 사용하지 않는다면(저도 사용하지 않습니다), 키워드를 통해 작동합니다. 어떤 키워드를 사용할지 고민할 필요 없이 모든 것이 자동화되어 있습니다.

### 메모리용으로 별도의 로어북을 만들어야 하나요, 아니면 다른 용도로 이미 사용 중인 로어북을 함께 사용해도 되나요?

메모리 로어북은 별도의 책으로 만드는 것을 권장합니다. 이렇게 하면 메모리를 정리하기가 더 쉽습니다(다른 항목과 비교했을 때). 예를 들어, 그룹 채팅에 추가하거나, 다른 채팅에서 사용하거나, (STLO를 사용하여) 개별 로어북 예산을 설정할 때 유리합니다.

### Memory Books가 유일한 로어북인 경우 'Delay until recursion'을 사용해야 하나요?

아니요. 다른 월드 인포나 로어북이 없는 경우 'Delay until recursion'을 선택하면 첫 번째 루프가 트리거되는 것을 방지하여 아무것도 활성화되지 않을 수 있습니다. Memory Books가 유일한 로어북인 경우, 'Delay until recursion'을 비활성화하거나 최소한 하나 이상의 추가 월드 인포/로어북이 구성되어 있는지 확인하세요.

---

# 문제 해결 (Troubleshooting)

- **사용 가능하거나 선택된 로어북이 없음:**
- 수동 모드(Manual Mode)인 경우, 메시지가 표시될 때 로어북을 선택하세요.
- 자동 모드(Automatic Mode)인 경우, 채팅에 로어북을 바인딩하세요.
- 또는 자동 생성을 위해 "Auto-create lorebook if none exists"를 활성화하세요.

- **선택된 장면이 없음:**
- 시작(►) 및 종료(◄) 지점을 모두 표시하세요.

- **장면이 기존 메모리와 겹침:**
- 다른 범위를 선택하거나 설정에서 "Allow scene overlap"을 활성화하세요.

- **AI가 유효한 메모리를 생성하지 못함:**
- JSON 출력을 지원하는 모델을 사용하세요.
- 프롬프트와 모델 설정을 확인하세요.

- **토큰 경고 임계값 초과:**
- 더 작은 장면을 사용하거나 임계값을 늘리세요.

- **쉐브론 버튼이 보이지 않음:**
- 확장 기능이 로드될 때까지 기다리거나 새로고침하세요.

- **캐릭터 데이터를 사용할 수 없음:**
- 채팅/그룹이 완전히 로드될 때까지 기다리세요.

---

## 📝 문자 정책 (v4.5.1+)

- **제목에 허용됨:** 악센트가 있는 문자, 이모지, 한중일(CJK) 문자 및 기호를 포함한 모든 출력 가능한 유니코드 문자가 허용됩니다.
- **차단됨:** 유니코드 제어 문자(U+0000–U+001F, U+007F–U+009F)만 차단되며, 이는 자동으로 제거됩니다.

## 예시와 마이그레이션 노트는 [문자 정책 세부 정보](https://www.google.com/search?q=charset.md)를 참조하세요.

_VS Code/Cline을 사용하여 사랑, 광범위한 테스트, 그리고 커뮤니티 피드백으로 개발되었습니다._ 🤖💕
