# 📕 Memory Books (SillyTavern 拡張機能)

自動的かつ構造的で信頼性の高いメモリ作成を行うための、次世代 SillyTavern 拡張機能です。チャット内のシーンをマークし、AIを使用してJSONベースの要約を生成し、それらを「[Vectorized（ベクトル化）](https://www.google.com/search?q=%23vectorized)」エントリとしてLorebook（世界詳細）に保存します。グループチャット、高度なプロファイル管理、および堅牢なAPI/モデル処理をサポートしています。

ここからスタート:

- ⚠️‼️インストールに関する注意点（特にText Completion APIを使用する場合）については、必ず[前提条件](https://www.google.com/search?q=%23-%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6)をお読みください。
- ❓ [よくある質問 (FAQ)](https://www.google.com/search?q=%23FAQ)
- 🛠️ [トラブルシューティング](https://www.google.com/search?q=%23Troubleshooting)

その他のリンク:

- 📘 [ユーザーガイド (英語)](https://www.google.com/search?q=USER_GUIDE.md)
- 📋 [バージョン履歴 & 更新ログ](changelog.md)
- 💡 [📕 Memory Books と 📚 Lorebook Ordering の併用について](https://github.com/aikohanasaki/SillyTavern-LorebookOrdering/blob/main/guides/STMB%20and%20STLO%20-%20English.md)

---

### 📚 Lorebook Ordering (STLO) でパワーアップ

高度なメモリ整理とストーリーへの深い統合のために、STMBを [SillyTavern-LorebookOrdering (STLO)](https://github.com/aikohanasaki/SillyTavern-LorebookOrdering/blob/main/guides/STMB%20and%20STLO%20-%20English.md) と併用することを強くお勧めします。ベストプラクティス、設定手順、ヒントについてはガイドをご覧ください！

> **注意:** 多言語に対応しています。リストについては [`/locales`](https://www.google.com/search?q=locales) フォルダを参照してください。各国語の Readme およびユーザーガイドは [`/userguides`](https://www.google.com/search?q=userguides) フォルダにあります。
> Lorebook コンバーターおよびサイドプロンプトのテンプレートライブラリは [`/resources`](https://www.google.com/search?q=resources) フォルダにあります。

---

## 📋 前提条件

- **SillyTavern:** 1.13.5以降 (最新版を推奨)
- ⚠️‼️**すべてのユーザー向けにインストールしてください:**‼️⚠️ STMBはSillyTavernの基本コードから多くの関数を再利用しているため、拡張機能の場所が `/public/scripts/extensions/third-party/SillyTavern-MemoryBooks` となるように、必ず「すべてのユーザー」向けにインストールしてください。そうしないと、関数のインポートに失敗します。
- **シーン選択:** 開始と終了のマーカー (開始 < 終了) が設定されている必要があります。
- **Chat Completion のサポート:** OpenAI, Claude, Anthropic, OpenRouter, その他の Chat Completion API をフルサポートしています。
- **Text Completion のサポート:** Text Completion API (Kobold, TextGen など) は、Chat Completion (OpenAI互換) API エンドポイント経由で接続されている場合にサポートされます。KoboldCppを使用している場合は、以下のヒントに従って Chat Completion API 接続を設定することをお勧めします（Ollamaや他のソフトウェアを使用している場合は適宜変更してください）。その後、STMBプロファイルを設定し、Custom（推奨）または完全手動設定（Customが失敗する場合や、複数のカスタム接続がある場合のみ）を使用してください。

### KoboldCpp で 📕 ST Memory Books を使用するためのヒント

SillyTavernで以下のように設定してください（STMBが動作するようになった後で、Text Completionに戻すことも可能です）。

- Chat Completion API を選択
- Chat Completion Source に Custom を選択
- Endpoint に `http://localhost:5001/v1` を入力 (または `127.0.0.1:5000/v1`)
- "Custom API Key" に任意の文字を入力 (何でも良いですが、ST側で入力が必須です)
- Model ID は必ず `koboldcpp/modelname` としてください (.gguf をモデル名に含めないでください！)
- 「Chat Completion Preset」をダウンロードしてインポートしてください（何でも構いません）。これは単に Chat Completion プリセットが存在する状態にするためで、「非対応（not supported）」エラーを回避するためです。

## 💡 Global World Info / Lorebook の推奨アクティベーション設定

- **Match Whole Words (完全一致):** チェックを外す (false)
- **Scan Depth (スキャン深度):** 高いほど良い (私は 8 に設定しています)
- **Max Recursion Steps (最大再帰ステップ):** 2 (一般的な推奨値、必須ではありません)
- **Context % (コンテキスト %):** 80% (100,000トークンのコンテキストウィンドウに基づく) - チャット履歴やボットが極端に重くないことを前提としています。

---

## 🚀 始め方

### 1. **インストールと読み込み**

- SillyTavern を起動し、キャラクターまたはグループチャットを選択します。
- チャットメッセージに山形ボタン (► ◄) が表示されるのを待ちます (最大10秒ほどかかる場合があります)。

### 2. **シーンをマークする**

- シーンの最初のメッセージで ► をクリックします。
- 最後のメッセージで ◄ をクリックします。

### 3. **メモリを作成する**

- 拡張機能メニュー (魔法の杖 🪄) を開き、「Memory Books」をクリックするか、`/creatememory` スラッシュコマンドを使用します。
- プロンプトが表示されたら設定 (プロファイル、コンテキスト、API/モデル) を確認します。
- AIによる生成とLorebookへの自動入力を待ちます。

---

## 🆕 スラッシュコマンドのショートカット

- `/creatememory` : 既存の山形マーカー（開始/終了）を使用してメモリを作成します。
- `/scenememory x-y` : メッセージ x から始まり メッセージ y で終わるメモリを作成します。
- `/nextmemory` : 最後のメモリ以降のすべてのメッセージを使用してメモリを作成します。

## 👥 グループチャットのサポート

- すべての機能がグループチャットで動作します。
- シーンマーカー、メモリ作成、Lorebookの統合はグループのメタデータに保存されます。
- 特別な設定は必要ありません。グループチャットを選択して通常通り使用してください。

---

## 🧭 動作モード

### **自動モード (Automatic Mode) - デフォルト**

- **仕組み:** 現在のチャットに紐付いている Lorebook を自動的に使用します。
- **用途:** シンプルかつ迅速に使いたい場合に最適です。ほとんどのユーザーはこのモードから始めてください。
- **使用法:** キャラクターまたはグループチャットの「Chat Lorebooks（チャットに関連付けられたLorebook）」ドロップダウンで、Lorebookが選択されていることを確認してください。

### **Lorebook 自動作成モード (Auto-Create Lorebook Mode)** ⭐ _v4.2.0の新機能_

- **仕組み:** Lorebookが存在しない場合、カスタム命名テンプレートを使用して新しい Lorebook を自動的に作成し、紐付けます。
- **用途:** 新規ユーザーや素早いセットアップに最適です。ワンクリックでLorebookを作成できます。
- **使用法:**

1. 拡張機能の設定で "Auto-create lorebook if none exists" を有効にします。
2. 命名テンプレートを設定します (デフォルト: "LTM - {{char}} - {{chat}}")。
3. Lorebookが紐付いていない状態でメモリを作成すると、自動的に作成・紐付けが行われます。

- **テンプレートのプレースホルダー:** {{char}} (キャラ名), {{user}} (ユーザー名), {{chat}} (チャットID)
- **スマートナンバリング:** 重複する名前が存在する場合、自動的に番号 (2, 3, 4...) を付与します。
- **注意:** 「手動 Lorebook モード」と同時に使用することはできません。

### **手動 Lorebook モード (Manual Lorebook Mode)**

- **仕組み:** メインのチャットに紐付いた Lorebook を無視し、チャットごとにメモリ用の異なる Lorebook を選択できます。
- **用途:** メモリを特定の別の Lorebook に保存したい上級ユーザー向けです。
- **使用法:**

1. 拡張機能の設定で "Enable Manual Lorebook Mode" を有効にします。
2. チャットで初めてメモリを作成する際に、Lorebookを選択するよう求められます。
3. この選択は、クリアするか自動モードに戻すまで、その特定のチャット用に保存されます。

- **注意:** 「Lorebook 自動作成モード」と同時に使用することはできません。

---

## 📝 メモリの生成

### **JSONのみの出力**

すべてのプロンプトとプリセットは、**必ず**有効なJSONのみを返すようにAIに指示する必要があります。例:

```json
{
  "title": "短いシーンタイトル",
  "content": "シーンの詳細な要約...",
  "keywords": ["キーワード1", "キーワード2"]
}
```

**レスポンスにこれ以外のテキストを含めることは許可されません。**

### **組み込みプリセット**

1. **Summary:** 詳細なビートごとの要約。
2. **Summarize:** タイムライン、ビート、相互作用、結果のMarkdownヘッダー付き。
3. **Synopsis:** 包括的で構造化されたMarkdown。
4. **Sum Up:** タイムライン付きの簡潔なビート要約。
5. **Minimal:** 1〜2文の要約。

### **カスタムプロンプト**

- 独自に作成可能ですが、上記のように**必ず**有効なJSONを返す必要があります。

---

## 📚 Lorebook 統合

- **自動エントリ作成:** 新しいメモリは、すべてのメタデータを含むエントリとして保存されます。
- **フラグベースの検出:** `stmemorybooks` フラグを持つエントリのみがメモリとして認識されます。
- **自動ナンバリング:** 複数の形式（`[000]`, `(000)`, `{000}`, `#000`）をサポートする、ゼロ埋めの連番。
- **手動/自動順序:** プロファイルごとの挿入順序設定。
- **エディタの更新:** メモリ追加後にLorebookエディタを自動的に更新するオプション。

> **既存のメモリは変換が必要です！**
> [Lorebook Converter](https://www.google.com/search?q=/resources/lorebookconverter.html) を使用して、`stmemorybooks` フラグと必須フィールドを追加してください。

---

### 🎡 サイドプロンプト (Side Prompts)

サイドプロンプトはトラッカーのように使用でき、メモリ用Lorebookにエントリを作成します。

- **アクセス:** Memory Books設定から “🎡 Side Prompt Manager” をクリックします。
- **機能:**
- すべてのサイドプロンプトを表示。
- 新規作成、またはプロンプトスタイルの実験用に既存のプロンプトを複製。
- 任意のプリセット（組み込みを含む）の編集や削除。
- バックアップや共有のためにプリセットをJSONファイルとしてエクスポートおよびインポート。
- 手動実行、またはメモリ作成時の自動実行。

- **使用のヒント:**
- 新しいプロンプトを作成する際は、互換性を保つために組み込みのものをコピーして利用できます。
- 追加のサイドプロンプト・テンプレートライブラリ [JSONファイル](https://www.google.com/search?q=resources/SidePromptTemplateLibrary.json) - インポートするだけで使用できます。

---

### 🧠 高度なカスタマイズのための Regex (正規表現) 統合

- **テキスト処理の完全な制御**: Memory Books は SillyTavern の **Regex** 拡張機能と統合され、以下の2つの主要なステージで強力なテキスト変換を適用できるようになりました。

1. **プロンプト生成**: **User Input (ユーザー入力)** の配置場所をターゲットにした正規表現スクリプトを作成することで、AIに送信されるプロンプトを自動的に修正します。
2. **レスポンス解析**: **AI Output (AI出力)** の配置場所をターゲットにすることで、AIの生のレスポンスが保存される前に、クリーンアップ、再フォーマット、または標準化を行います。

- **複数選択のサポート**: 正規表現スクリプトを複数選択できるようになりました。有効になったすべてのスクリプトは、各ステージ（プロンプト生成およびレスポンス解析）で順番に適用され、高度で柔軟な変換が可能になります。
- **仕組み**: 統合はシームレスです。Regex拡張機能で希望のスクリプトを作成して有効化（複数選択）するだけで、Memory Booksはメモリおよびサイドプロンプトの作成中にそれらを自動的に適用します。

---

## 👤 プロファイル管理

- **プロファイル:** 各プロファイルには、API、モデル、Temperature、プロンプト/プリセット、タイトル形式、および Lorebook 設定が含まれます。
- **インポート/エクスポート:** プロファイルをJSONとして共有できます。
- **プロファイル作成:** 高度なオプションのポップアップを使用して新しいプロファイルを保存します。
- **プロファイルごとのオーバーライド:** メモリ作成時に一時的に API/モデル/Temperature を切り替え、その後元の設定に戻すことができます。

---

## ⚙️ 設定と構成

### **グローバル設定**

[Youtubeでの短い概要ビデオ](https://youtu.be/mG2eRH_EhHs)

- **Manual Lorebook Mode:** チャットごとにLorebookを選択できるようにします。
- **Auto-create lorebook if none exists:** ⭐ _v4.2.0の新機能_ - 命名テンプレートを使用してLorebookを自動的に作成・紐付けします。
- **Lorebook Name Template:** ⭐ _v4.2.0の新機能_ - {{char}}, {{user}}, {{chat}} プレースホルダーを使用して自動作成されるLorebook名をカスタマイズします。
- **Allow Scene Overlap:** メモリ範囲の重複を許可または防止します。
- **Always Use Default Profile:** 確認ポップアップをスキップします。
- **Show memory previews:** メモリをLorebookに追加する前にレビューおよび編集するためのプレビューポップアップを表示します。
- **Show Notifications:** トーストメッセージの表示を切り替えます。
- **Refresh Editor:** メモリ作成後にLorebookエディタを自動更新します。
- **Token Warning Threshold:** 大規模なシーンに対する警告レベルを設定します（デフォルト: 30,000）。
- **Default Previous Memories:** コンテキストとして含める過去のメモリ数 (0〜7)。
- **Auto-create memory summaries:** 一定間隔での自動メモリ作成を有効にします。
- **Auto-Summary Interval:** メモリ要約を自動作成するメッセージ間隔 (10〜200, デフォルト: 100)。
- **Memory Title Format:** タイトル形式の選択またはカスタマイズ（下記参照）。

### **プロファイルフィールド**

- **Name:** 表示名。
- **API/Provider:** openai, claude, custom など。
- **Model:** モデル名 (例: gpt-4, claude-3-opus)。
- **Temperature:** 0.0〜2.0。
- **Prompt or Preset:** カスタムまたは組み込み。
- **Title Format:** プロファイルごとのテンプレート。
- **Activation Mode:** Vectorized, Constant, Normal。
- **Position:** ↑Char, ↓Cha, ↑EM, ↓EM, ↑AN, Outlet (およびフィールド名)。
- **Order Mode:** Auto (自動) / Manual (手動)。
- **Recursion:** 再帰の防止/遅延。

---

## 🏷️ タイトルフォーマット

強力なテンプレートシステムを使用して、Lorebookエントリのタイトルをカスタマイズできます。

- **プレースホルダー:**
- `{{title}}` - AIによって生成されたタイトル (例: "A Fateful Encounter")。
- `{{scene}}` - メッセージの範囲 (例: "Scene 15-23")。
- `{{char}}` - キャラクターの名前。
- `{{user}}` - ユーザー名。
- `{{messages}}` - シーン内のメッセージ数。
- `{{profile}}` - 生成に使用されたプロファイル名。
- 現在の日付/時刻の様々な形式のプレースホルダー (例: 日付は `August 13, 2025`、時刻は `11:08 PM`)。

- **自動ナンバリング:** `[0]`, `[00]`, `(0)`, `{0}`, `#0` に加え、連番のゼロ埋めに対応した `#[000]`, `([000])`, `{[000]}` のような括弧付き形式も使用できます。
- **カスタムフォーマット:** 独自のフォーマットを作成できます。v4.5.1以降、すべての印刷可能なUnicode文字（絵文字、CJK、アクセント付き文字、記号などを含む）がタイトルで使用可能です。Unicode制御文字のみがブロックされます。

---

## 🧵 コンテキストメモリ

- **最大7つの過去のメモリ** をコンテキストとして含めることで、継続性を向上させます。
- **トークン見積もり** には、正確性を期すためにコンテキストメモリも含まれます。

---

## 🎨 視覚的フィードバックとアクセシビリティ

- **ボタンの状態:**
- 非アクティブ、アクティブ、有効な選択、シーン内、処理中。

- **アクセシビリティ:**
- キーボードナビゲーション、フォーカスインジケータ、ARIA属性、視差効果の低減、モバイル対応。

---

# FAQ (よくある質問)

### Extensions メニューに Memory Books が見つかりません！

設定は「Extensions（拡張機能）」メニュー（入力ボックスの左にある魔法の杖 🪄）にあります。「Memory Books」を探してください。

### Vectors (ベクトル) を実行する必要がありますか？

World Info の 🔗 エントリは、STのUIでは「vectorized」と名付けられています。そのため、私は「vectorized」という言葉を使用しています。もしあなたが Vectors 拡張機能を使用していない場合（私も使用していません）、これはキーワードを介して機能します。どのキーワードを使用すべきかを考える必要がないように、これらはすべて自動化されています。

### メモリ用に別の Lorebook を作るべきですか、それとも他の用途ですでに使っている Lorebook を使ってもいいですか？

メモリ用の Lorebook は別のブックにすることをお勧めします。これにより、（他のエントリと比較して）メモリの整理が容易になります。例えば、グループチャットに追加したり、別のチャットで使用したり、個別の Lorebook 予算を設定（STLOを使用）したりする場合などです。

### Memory Books が唯一の Lorebook である場合、「Delay until recursion（再帰まで遅延）」を使用すべきですか？

いいえ。他の World Info や Lorebook がない場合、「Delay until recursion」を選択すると最初のループがトリガーされず、何もアクティブにならない可能性があります。Memory Books が唯一の Lorebook である場合は、「Delay until recursion」を無効にするか、少なくとも1つの追加の World Info / Lorebook が設定されていることを確認してください。

---

# トラブルシューティング

- **Lorebook が利用できない、または選択されていない:**
- 手動モードの場合、プロンプトが表示されたら Lorebook を選択してください。
- 自動モードの場合、チャットに Lorebook を紐付けてください。
- または、自動作成のために "Auto-create lorebook if none exists" を有効にしてください。

- **シーンが選択されていない:**
- 開始 (►) と終了 (◄) の両方のポイントをマークしてください。

- **シーンが既存のメモリと重複している:**
- 異なる範囲を選択するか、設定で "Allow scene overlap" を有効にしてください。

- **AI が有効なメモリの生成に失敗した:**
- JSON出力をサポートするモデルを使用してください。
- プロンプトとモデル設定を確認してください。

- **トークン警告のしきい値を超えた:**
- より小さなシーンを使用するか、しきい値を上げてください。

- **山形ボタンが見つからない:**
- 拡張機能が読み込まれるのを待つか、リフレッシュしてください。

- **キャラクターデータが利用できない:**
- チャット/グループが完全に読み込まれるのを待ってください。

---

## 📝 文字ポリシー (v4.5.1以降)

- **タイトルで使用可能:** アクセント付き文字、絵文字、CJK（中国語・日本語・韓国語）、記号を含む、すべての印刷可能なUnicode文字が許可されています。
- **ブロック対象:** Unicode制御文字 (U+0000–U+001F, U+007F–U+009F) のみがブロックされ、自動的に削除されます。

## 例や移行に関する注記については [Character Policy Details (文字ポリシーの詳細)](https://www.google.com/search?q=charset.md) を参照してください。

_VS Code/Cline、広範なテスト、およびコミュニティのフィードバックを使用して愛情を込めて開発されました。_ 🤖💕
